#!/usr/bin/env bash
set -euo pipefail

# Screen recording script for niri using wf-recorder
# Usage: niri-record [region|screen]
#   - No args or "screen": records the focused monitor
#   - "region": lets you select a region with slurp

SAVE_DIR="$HOME/Videos/recordings"
mkdir -p "$SAVE_DIR"

PIDFILE="$HOME/.cache/wf-recorder.pid"
mkdir -p "$(dirname "$PIDFILE")"

notify() {
  if command -v notify-send >/dev/null 2>&1; then
    notify-send -a "Screen Recorder" "$@"
  fi
}

open_latest() {
  local latest
  latest="$(ls -t "$SAVE_DIR"/*.mp4 2>/dev/null | head -1 || true)"

  if [[ -z "${latest:-}" ]]; then
    notify "Recording stopped" "No recordings found"
    return 0
  fi

  if command -v losslesscut >/dev/null 2>&1; then
    notify "Recording stopped" "Opening in LosslessCut"
    losslesscut "$latest" &
  elif command -v vlc >/dev/null 2>&1; then
    notify "Recording stopped" "Opening in VLC"
    vlc "$latest" &
  else
    notify "Recording stopped" "Saved to $latest"
  fi
}

# ----------------------------
# STOP if already recording
# ----------------------------
if [[ -f "$PIDFILE" ]]; then
  PID="$(cat "$PIDFILE" || true)"
  if [[ -n "${PID:-}" ]] && kill -0 "$PID" 2>/dev/null; then
    kill -INT "$PID" 2>/dev/null || true
    sleep 2
    kill -0 "$PID" 2>/dev/null && kill -KILL "$PID" 2>/dev/null || true
    rm -f "$PIDFILE"
    open_latest
    exit 0
  else
    rm -f "$PIDFILE"
  fi
fi

# ----------------------------
# START recording
# ----------------------------
FILENAME="$SAVE_DIR/Recording-$(date +%F_%H-%M-%S).mp4"

if [[ "${1:-}" == "region" ]]; then
  REGION="$(slurp)" || exit 1
  wf-recorder -c libx264 -g "$REGION" -f "$FILENAME" >/tmp/wf-recorder.log 2>&1 &
else
  # Get focused output from niri
  OUTPUT="$(niri msg -j focused-output | jq -r '.name')"

  if [[ -z "${OUTPUT:-}" || "$OUTPUT" == "null" ]]; then
    notify "Recording failed" "Couldn't detect focused monitor"
    exit 1
  fi

  wf-recorder -c libx264 -o "$OUTPUT" -f "$FILENAME" >/tmp/wf-recorder.log 2>&1 &
fi

echo $! >"$PIDFILE"

# Detect instant failure
sleep 0.15
PID="$(cat "$PIDFILE" || true)"
if [[ -n "${PID:-}" ]] && ! kill -0 "$PID" 2>/dev/null; then
  rm -f "$PIDFILE"
  notify "Recording failed" "wf-recorder exited. See /tmp/wf-recorder.log"
  exit 1
fi

# Show notification with action button to stop
(
    action=$(notify-send -a "Screen Recorder" "Recording started" "Click to stop" --action="stop=Stop Recording")
    if [[ "$action" == "stop" ]]; then
        niri-record
    fi
) &
